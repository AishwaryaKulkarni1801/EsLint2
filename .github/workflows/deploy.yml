name: Deploy Angular App to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

environment:
  name: github-pages

jobs:
  test-and-validate:
    runs-on: ubuntu-latest
    name: üß™ Test & Validate Code Quality
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          
      - name: üì¶ Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: üì¶ Install dependencies
        run: npm ci
        
      - name: üß™ Run Jest tests with coverage
        run: npm run test -- --coverage --watchAll=false
        
      - name: üìä Check test coverage
        run: |
          # Extract coverage percentage from Jest output
          COVERAGE=$(npm run test:ci 2>&1 | grep -oP 'All files\s+\|\s+\K\d+\.\d+' | head -1)
          echo "Test coverage: $COVERAGE%"
          
          # Convert to integer for comparison
          COVERAGE_INT=$(echo "$COVERAGE" | cut -d'.' -f1)
          
          if [ "$COVERAGE_INT" -lt 80 ]; then
            echo "‚ùå Deployment stopped due to low test coverage (<80%)" >> $GITHUB_STEP_SUMMARY
            echo "Current coverage: $COVERAGE%" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "‚úÖ Test coverage ($COVERAGE%) meets requirement (‚â•80%)" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: üîç Run ESLint validation
        run: |
          # Run ESLint and capture output
          if npm run lint 2>&1 | tee eslint-output.log; then
            # Check if there are any errors (not just warnings)
            if grep -q "error" eslint-output.log; then
              echo "‚ùå Deployment stopped due to ESLint errors" >> $GITHUB_STEP_SUMMARY
              echo "Please fix the following ESLint errors:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep "error" eslint-output.log >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "‚úÖ ESLint validation passed" >> $GITHUB_STEP_SUMMARY
              if grep -q "warning" eslint-output.log; then
                echo "‚ö†Ô∏è ESLint warnings found but deployment will continue" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "‚ùå Deployment stopped due to ESLint errors" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  build-and-deploy:
    runs-on: ubuntu-latest
    name: üèóÔ∏è Build & Deploy to GitHub Pages
    needs: test-and-validate
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          
      - name: üì¶ Install dependencies
        run: npm ci
        
      - name: üîç Detect Angular project name
        id: project-info
        run: |
          PROJECT_NAME=$(jq -r '.projects | keys[0]' angular.json)
          OUTPUT_PATH=$(jq -r ".projects.\"$PROJECT_NAME\".architect.build.options.outputPath" angular.json)
          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "output_path=$OUTPUT_PATH" >> $GITHUB_OUTPUT
          echo "Detected project: $PROJECT_NAME" >> $GITHUB_STEP_SUMMARY
          echo "Output path: $OUTPUT_PATH" >> $GITHUB_STEP_SUMMARY
          
      - name: üèóÔ∏è Build Angular project
        run: |
          npm run build -- --base-href '/EsLint2/'
          echo "‚úÖ Angular build completed successfully" >> $GITHUB_STEP_SUMMARY
          
      - name: üìÑ Copy index.html to 404.html for SPA routing
        run: |
          cp ${{ steps.project-info.outputs.output_path }}/index.html ${{ steps.project-info.outputs.output_path }}/404.html
          echo "‚úÖ Created 404.html for SPA routing support" >> $GITHUB_STEP_SUMMARY
          
      - name: ‚öôÔ∏è Configure GitHub Pages
        uses: actions/configure-pages@v4
        
      - name: üì§ Upload build artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ steps.project-info.outputs.output_path }}
          
      - name: üöÄ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify-success:
    runs-on: ubuntu-latest
    name: üéâ Notify Deployment Success
    needs: [test-and-validate, build-and-deploy]
    
    steps:
      - name: üéâ Success notification
        run: |
          echo "### ‚úÖ Deployment Successful üéâ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó **[View Site](https://AishwaryaKulkarni1801.github.io/EsLint2/)**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üß™ All tests passed & ESLint validation cleared." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Deployment Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** EsLint2" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "- **Framework:** Angular" >> $GITHUB_STEP_SUMMARY
          echo "- **Node.js:** LTS" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîß Quality Gates Passed:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Jest Tests with Coverage ‚â• 80%" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ ESLint Validation (No Errors)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Angular Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ GitHub Pages Deployment" >> $GITHUB_STEP_SUMMARY